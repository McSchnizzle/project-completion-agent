<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Audit Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { color: #00d9ff; margin-bottom: 20px; }
    .status-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .status-card { background: #16213e; padding: 15px 20px; border-radius: 8px; flex: 1; min-width: 150px; }
    .status-card h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 5px; }
    .status-card .value { font-size: 24px; font-weight: bold; }
    .status-running { color: #4ade80; }
    .status-paused { color: #fbbf24; }
    .status-complete { color: #60a5fa; }
    .severity-p0 { background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; }
    .severity-p1 { background: #f97316; color: white; padding: 2px 8px; border-radius: 4px; }
    .severity-p2 { background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; }
    .findings-row { display: flex; gap: 10px; }
    .activity-log { background: #16213e; padding: 15px; border-radius: 8px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
    .activity-log h3 { margin-bottom: 10px; color: #00d9ff; }
    .log-entry { padding: 8px 0; border-bottom: 1px solid #2a2a4a; font-size: 14px; }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: #888; margin-right: 10px; }
    .controls { margin-top: 20px; display: flex; gap: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-stop { background: #ef4444; color: white; }
    .btn-stop:disabled { background: #555; cursor: not-allowed; }
    .btn-continue { background: #4ade80; color: #1a1a2e; }
    .btn-continue:disabled { background: #555; color: #888; cursor: not-allowed; }
    .pause-reason { background: #fbbf24; color: #1a1a2e; padding: 10px 15px; border-radius: 6px; margin-top: 10px; }
    .connecting { color: #888; font-style: italic; }
    .current-url { font-size: 14px; color: #888; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Complete Audit Dashboard</h1>

    <div class="status-bar">
      <div class="status-card">
        <h3>Status</h3>
        <div class="value" id="status">Connecting...</div>
      </div>
      <div class="status-card">
        <h3>Pages Visited</h3>
        <div class="value" id="pages-visited">-</div>
      </div>
      <div class="status-card">
        <h3>In Queue</h3>
        <div class="value" id="pages-queue">-</div>
      </div>
      <div class="status-card">
        <h3>Findings</h3>
        <div class="value findings-row">
          <span class="severity-p0" id="findings-p0">0</span>
          <span class="severity-p1" id="findings-p1">0</span>
          <span class="severity-p2" id="findings-p2">0</span>
        </div>
      </div>
    </div>

    <div class="current-url" id="current-url"></div>
    <div class="pause-reason" id="pause-reason" style="display:none"></div>

    <div class="controls">
      <button class="btn btn-stop" id="btn-stop" onclick="stopAudit()">Stop Audit</button>
      <button class="btn btn-continue" id="btn-continue" onclick="continueAudit()" style="display:none">Continue</button>
      <a class="btn" id="btn-report" href="/audits/current/report.md" style="display:none;background:#60a5fa;color:white;text-decoration:none">View Report</a>
    </div>

    <div class="completion-summary" id="completion-summary" style="display:none;background:#16213e;padding:15px;border-radius:8px;margin-top:10px">
      <h3 style="color:#4ade80;margin-bottom:10px">âœ“ Audit Complete</h3>
      <div id="summary-text"></div>
    </div>

    <div class="activity-log">
      <h3>Activity Log</h3>
      <div id="activity-log"><div class="log-entry connecting">Waiting for audit data...</div></div>
    </div>
  </div>

  <script>
    let polling = true;
    let lastStatus = null;

    async function fetchProgress() {
      try {
        const res = await fetch('/audits/current/progress.json');
        if (!res.ok) throw new Error('Not found');
        const data = await res.json();
        updateUI(data);
      } catch (e) {
        document.getElementById('status').textContent = 'Connecting...';
        document.getElementById('status').className = 'value connecting';
      }
    }

    function updateUI(data) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
      statusEl.className = 'value status-' + data.status;

      document.getElementById('pages-visited').textContent = data.coverage?.pages_visited ?? data.pages_visited ?? '-';
      document.getElementById('pages-queue').textContent = data.coverage?.pages_in_queue ?? data.pages_in_queue ?? '-';
      document.getElementById('findings-p0').textContent = data.findings?.by_severity?.P0 ?? data.findings_by_severity?.P0 ?? 0;
      document.getElementById('findings-p1').textContent = data.findings?.by_severity?.P1 ?? data.findings_by_severity?.P1 ?? 0;
      document.getElementById('findings-p2').textContent = data.findings?.by_severity?.P2 ?? data.findings_by_severity?.P2 ?? 0;

      if (data.current_url) {
        document.getElementById('current-url').textContent = 'Current: ' + data.current_url;
      }

      // Pause reason
      const pauseEl = document.getElementById('pause-reason');
      if (data.status === 'paused' && data.pause_reason) {
        pauseEl.textContent = 'Paused: ' + data.pause_reason;
        pauseEl.style.display = 'block';
      } else {
        pauseEl.style.display = 'none';
      }

      // Button states
      document.getElementById('btn-stop').disabled = (data.status === 'complete');
      document.getElementById('btn-stop').style.display = (data.status === 'complete') ? 'none' : 'inline-block';
      document.getElementById('btn-continue').style.display = (data.status === 'paused') ? 'inline-block' : 'none';
      document.getElementById('btn-report').style.display = (data.status === 'complete') ? 'inline-block' : 'none';

      // Completion summary
      const summaryEl = document.getElementById('completion-summary');
      if (data.status === 'complete') {
        const total = data.findings?.total ?? 0;
        const p0 = data.findings?.by_severity?.P0 ?? 0;
        document.getElementById('summary-text').innerHTML =
          `Found ${total} findings (${p0} critical). View the report for details.`;
        summaryEl.style.display = 'block';
      } else {
        summaryEl.style.display = 'none';
      }

      // Activity log (prepend new entries, keep last 10)
      if (data.activity_log && data.activity_log.length) {
        const logHtml = data.activity_log.slice(0, 10).map(entry => {
          const time = new Date(entry.timestamp).toLocaleTimeString();
          return `<div class="log-entry"><span class="log-time">${time}</span>${entry.action}: ${entry.detail || ''}</div>`;
        }).join('');
        document.getElementById('activity-log').innerHTML = logHtml;
      }

      // Stop polling on complete
      if (data.status === 'complete' && lastStatus !== 'complete') {
        polling = false;
      }
      lastStatus = data.status;
    }

    function stopAudit() {
      alert('To stop the audit, run:\n\ntouch .complete-agent/audits/current/stop.flag');
    }

    function continueAudit() {
      alert('To continue the audit, run:\n\ntouch .complete-agent/audits/current/continue.flag');
    }

    // Poll every 2 seconds
    setInterval(() => { if (polling) fetchProgress(); }, 2000);
    fetchProgress();
  </script>
</body>
</html>

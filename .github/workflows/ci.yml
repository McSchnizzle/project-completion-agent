name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npx vitest run

      - name: Schema validation check
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const dir = 'skill/schemas';
            const files = fs.readdirSync(dir).filter(f => f.endsWith('.json'));
            let errors = 0;
            for (const f of files) {
              try {
                JSON.parse(fs.readFileSync(path.join(dir, f), 'utf-8'));
                console.log('  OK: ' + f);
              } catch(e) {
                console.error('  FAIL: ' + f + ' - ' + e.message);
                errors++;
              }
            }
            if (errors > 0) process.exit(1);
            console.log('All ' + files.length + ' schemas valid.');
          "
